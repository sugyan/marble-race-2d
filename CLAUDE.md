# 2D Marble Race

## プロジェクト概要

iPad横向き全画面表示を前提とした2Dマーブルレースシミュレーション。
複数のボールが物理エンジンにより予測困難な動きをしながらゴールを目指す。

## 技術スタック

- **フレームワーク**: React 19.2.0 + TypeScript
- **ビルドツール**: Vite 7.2.4 (SWC)
- **物理エンジン**: Matter.js
- **レンダリング**: Matter.js組み込みレンダラー (Canvas API)

## 実装機能

### コア機能

1. **物理シミュレーション**
   - Matter.jsによるリアルな2D物理演算
   - スリープモード無効化（`enableSleeping: false`）でボールが止まりにくい設定
   - 重力: `{ x: 0, y: 0.8 }` - やや弱めの重力でゆったりとした動き
   - 残像効果: Canvas clearRectをオーバーライドして半透明背景でフェード

2. **ボール**
   - **20個のビビッドカラーボール**
   - ランダムな初期位置（画面幅60%×高さ15%の範囲）
   - 画面サイズに応じて動的にサイズ調整（画面サイズの1.5%）
   - **カラーパレット**: 20色の高彩度カラー（純色に近い鮮やかな色）
   - 物理パラメータ:
     - `restitution: 0.98` - 極めて高い弾性（ほぼ完全弾性衝突）
     - `friction: 0.001` - 極めて低い摩擦（滑りやすい）
     - `frictionStatic: 0` - 静止摩擦ゼロ（止まりにくい）
     - `frictionAir: 0.0005` - 低い空気抵抗

3. **コース設計**

   **漏斗状の壁**:
   - 階段状に配置された垂直壁（左右各8セグメント）
   - 上部: 画面幅100%、下部: 画面幅50%に狭まる
   - ボールが横から落ちるのを防ぐ

   **固定プラットフォーム（6-9個、ランダム）**:
   - 幾何学的配置パターン（4種類からランダム選択）:
     1. **螺旋（Spiral）**: 黄金角を使用したフィボナッチ螺旋配置
     2. **放射状（Radial）**: 3層の同心円状配置
     3. **グリッド（Grid）**: 4列のグリッドにランダムオフセット
     4. **対称（Symmetric）**: 左右対称の鏡像配置
   - 形状バリエーション（3種類）:
     - 長方形: シンプルな板状
     - 三角形: 鋭角で激しい反射
     - 星型: 5つの尖りで予測不可能な動き
   - **回転アニメーション**: 各プラットフォームが独立して回転（-0.01 ~ 0.01 rad/frame）
   - 傾斜角度: 0.25〜0.35ラジアン（約14〜20度）
   - サイズ: 画面幅の15〜25%（大きめ）
   - 物理パラメータ:
     - `friction: 0.001` - 低摩擦
     - `restitution: 0.8` - 高反発

   **動く障害物（4個）**:
   - 幾何学的な動きパターン:
     1. **円運動**: 完全な円軌道 + 自転
     2. **楕円運動**: 楕円軌道 + ゆっくり回転
     3. **リサージュ曲線**: 3:2の周波数比で複雑な軌跡
     4. **8の字運動**: ∞記号のような流れる動き
   - すべて中央を基点に配置
   - 各障害物が独自の速度で動作

4. **ゴールシステム**
   - 画面下部に緑色（`#00FF00`）のゴールライン
   - `isSensor: true` でボールはすり抜けるが衝突検知は有効
   - **19個がゴールした時点でゴールラインが消える**
   - **最後の1個は画面に残り続ける**（敗者として永遠に動き続ける）

5. **UI機能**
   - リアルタイムランキング表示（右側パネル）
   - ゴール順に自動ソート（最大19個まで表示）
   - ボール番号と色で識別

### レスポンシブ対応

- **全画面表示**: 100vw × 100vh を使用
- **動的Canvas サイズ**: ランキングパネル（250px）を除いた領域に自動調整
- **相対座標系**: すべてのオブジェクト位置を画面サイズに対する比率で管理

## プロジェクト構成

```
src/
├── components/
│   └── MarbleRace.tsx    # メインコンポーネント（物理エンジン、レンダリング、UI）
├── App.tsx               # ルートコンポーネント
├── App.css              # アプリケーションスタイル
├── main.tsx             # エントリーポイント
└── index.css            # グローバルスタイル
```

## 自動動作

- ページ読み込み完了後、自動的にレース開始
- ボタン操作不要（以前のStart/Resetボタンは削除済み）

## 物理エンジン調整のポイント

### 止まりにくくするための設定

1. **スリープ無効化**: Matter.jsはデフォルトで静止したボディを「眠らせる」が、これを無効化
2. **静止摩擦ゼロ**: 静止状態からの動き出しを容易に
3. **極低摩擦**: 動摩擦を限りなくゼロに近づける
4. **超高反発**: `restitution: 0.98` でほぼ完全弾性衝突、エネルギーをほとんど失わない
5. **漏斗状の壁**: ボールが横から落ちるのを防ぎ、必ずゴールに向かう

### 予測困難性の実現

1. **幾何学的配置**: 4種類のランダムなパターンで毎回異なるコース
2. **急な傾斜**: 0.25〜0.35ラジアン（14〜20度）でボールが滑り落ちる
3. **回転する障害物**: 固定プラットフォームが回転し、時間とともに反射角が変化
4. **複雑な形状**: 星型や三角形の尖った部分が予測不可能な反射を生む
5. **幾何学的な動き**: 円運動、リサージュ曲線など数学的に美しい動きパターン
6. **ボール同士の衝突**: 20個のボールが高速で跳ね回り、複雑な連鎖反応
7. **ランダムな初期位置**: 毎回異なる開始位置で展開が変わる

### ビジュアル表現

1. **残像効果**: Canvas clearRectをオーバーライドして半透明フェード
   - 高速で動くボールの軌跡が美しく可視化される
2. **高彩度カラー**: 20色のビビッドな色でボールを識別しやすく
3. **幾何学的デザイン**: 黄金角、フィボナッチ数列などの数学的美しさ

## 今後の拡張可能性

- ボール数の調整機能
- 障害物パターンのバリエーション
- リプレイ機能
- 統計情報の表示（平均時間、最速記録など）
- コースエディター
- 複数レーン対応
